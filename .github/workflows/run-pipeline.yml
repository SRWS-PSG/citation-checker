name: Run Ref Audit
on:
  workflow_dispatch:
  push:
    paths:
      - "input/references.txt"
jobs:
  run:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    - run: python -m pip install -e .
    - name: Create .env (with fallback)
      run: |
        if [ -n "${{ secrets.CONTACT_EMAIL }}" ]; then
          echo "CONTACT_EMAIL=${{ secrets.CONTACT_EMAIL }}" > .env
        else
          echo "CONTACT_EMAIL=you@example.com" > .env
        fi
    - name: Ensure input exists (graceful default)
      run: |
        mkdir -p input
        if [ ! -f input/references.txt ]; then
          echo "(info) input/references.txt not found; running with empty input" >&2
          : > input/references.txt
        fi
    - name: Run audit
      run: |
        python -m refaudit.main --text "$(cat input/references.txt)" --out outputs/report.md
        echo "=== outputs/report.md ==="
        sed -n '1,120p' outputs/report.md
    - name: Commit report
      uses: stefanzweifel/git-auto-commit-action@v5
      with:
        commit_message: "chore: update report.md"
        file_pattern: outputs/report.md
